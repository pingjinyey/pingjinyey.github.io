{{/* Hugo Blox: Slider (Tailwind, fixed height + slide animation + hidden fallback) */}}
{{- $page := .wcPage -}}
{{- $block := .wcBlock -}}
{{- $hash := .wcIdentifier -}}
{{- $slides := $block.content.slides | default (slice) -}}
{{- $count := len $slides -}}

{{- $isFullscreen := $block.design.is_fullscreen | default false -}}
{{- $slideHeight := $block.design.slide_height | default "" -}}
{{- $autoPlay := $block.design.auto_play | default false -}}
{{- $interval := $block.design.interval_ms | default 5000 -}}

{{- $containerStyle := "" -}}
{{- if $slideHeight -}}
  {{- $containerStyle = printf "height:%s;" $slideHeight -}}
{{- else if $isFullscreen -}}
  {{- $containerStyle = "height:100vh;" -}}
{{- else -}}
  {{- $containerStyle = "height:60vh;" -}}
{{- end -}}

<section id="{{ $hash }}"
         class="{{ $block.design.css_class }} outline-none focus:outline-none focus-visible:outline-none"
         data-hbx-slider
         data-auto-play="{{ cond $autoPlay "true" "false" }}"
         data-interval="{{ $interval }}">
  <div class="relative w-full overflow-hidden rounded-2xl bg-gray-100 dark:bg-gray-900" style="{{ $containerStyle | safeCSS }}">
    <!-- 轨道：绝对定位，子项重叠 -->
    <div class="absolute inset-0">
      {{- range $idx, $item := $slides -}}
        {{- $styleBg := "" -}}
        {{- $styleFilter := "" -}}
        {{- $bg := $item.background -}}

        {{- with $bg.color -}}
          {{- $styleBg = printf "%s background-color:%s;" $styleBg (. | default "transparent") -}}
        {{- end -}}

        {{- if and $bg.gradient_start $bg.gradient_end -}}
          {{- $angle := (string $bg.gradient_angle) | default "90" -}}
          {{- $styleBg = printf "%s background-image:linear-gradient(%sdeg,%s,%s);" $styleBg $angle $bg.gradient_start $bg.gradient_end -}}
        {{- end -}}

        {{/* 仅从 assets/media 读取背景图（稳定） */}}
        {{- $imgURL := "" -}}
        {{- with $bg.image.filename -}}
          {{- $fname := . -}}
          {{- $res := resources.Get (printf "media/%s" $fname) -}}
          {{- if $res -}}
            {{- $imgURL = $res.RelPermalink -}}
            {{- $pos := $bg.image.position | default "center" -}}
            {{- $size := $bg.image.size | default "cover" -}}
            {{- $styleBg = printf "%s background-image:url('%s'); background-repeat:no-repeat; background-position:%s; background-size:%s;" $styleBg $imgURL $pos $size -}}
          {{- else -}}
            {{- warnf "slider-tw: NOT FOUND assets/media/%s (check path/case/extension)" $fname -}}
          {{- end -}}
          {{- with $bg.image.filters.brightness -}}
            {{- $styleFilter = printf "%s filter:brightness(%s);" $styleFilter (string .) -}}
          {{- end -}}
        {{- end -}}

        {{- $align := $item.align | default "left" -}}
        {{- $alignText := cond (eq $align "center") "text-center" (cond (eq $align "right") "text-right" "text-left") -}}
        {{- $mx := cond (eq $align "center") "mx-auto" (cond (eq $align "right") "ml-auto" "mr-auto") -}}

        <!-- 每张 Slide：非首张先 hidden；动画用 translate-x / opacity 类 -->
        <div
          class="hbxtw-slide absolute inset-0 z-10 flex items-center justify-center transition-transform duration-500 ease-out
                 {{ if eq $idx 0 }}opacity-100 translate-x-0 pointer-events-auto{{ else }}opacity-0 translate-x-full pointer-events-none hidden{{ end }}"
          style="{{ $styleBg | safeCSS }} display:block;"
        >
          <!-- 背景滤镜层：不拦截点击 -->
          <div class="absolute inset-0 pointer-events-none" style="{{ $styleFilter | safeCSS }}"></div>

          <!-- 可读性遮罩（从下到上渐变，可按需调整透明度） -->
          <div class="absolute inset-0 pointer-events-none bg-gradient-to-t from-black/40 via-black/20 to-transparent"></div>

          <!-- 内容 -->
          <div class="relative z-10 w-full max-w-6xl {{ $mx }} px-6">
            <div class="{{ $alignText }}">
              {{ with $item.title }}
                <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight text-gray-100 drop-shadow-md">
                  {{ . | markdownify | emojify }}
                </h1>
              {{ end }}
              {{ with $item.content }}
                <p class="mt-4 text-lg md:text-xl text-gray-100/95 max-w-3xl {{ $mx }}">
                  {{ . | emojify | $page.RenderString }}
                </p>
              {{ end }}
              {{ if $item.link.url }}
                <p class="mt-6">
<a href="{{ $item.link.url }}"
   class="inline-flex items-center rounded-full px-5 py-2.5 text-base font-medium
          text-white shadow
          bg-gradient-to-r from-primary-500 to-primary-600
          hover:from-primary-600 hover:to-primary-700
          transition-colors shadow
          focus:outline-none focus:ring-2 focus:ring-white/70">
  {{ $item.link.text | default "Learn more" | emojify | markdownify | safeHTML }}
</a>
                </p>
              {{ end }}
            </div>
          </div>
        </div>
      {{- end -}}
    </div>

    <!-- 指示点 -->
    {{ if gt $count 1 }}
      <div class="absolute bottom-4 left-0 right-0 flex items-center justify-center gap-2 z-50 pointer-events-auto">
        {{ range $i, $_ := $slides }}
          <button class="h-2.5 w-2.5 rounded-full bg-white/70 dark:bg-gray-700/70 ring-1 ring-black/10 dark:ring-white/10 transition
                         data-[active=true]:w-6 data-[active=true]:bg-white data-[active=true]:dark:bg-white"
                  data-indicator="{{ $i }}" aria-label="Go to slide {{ add $i 1 }}"></button>
        {{ end }}
      </div>

      <!-- 页码计数 -->
      <div class="absolute bottom-4 right-4 z-50 text-white/90 text-sm px-2 py-1 rounded bg-black/30">
        <span data-counter>1</span>/{{ $count }}
      </div>
    {{ end }}

    <!-- 左右控制 -->
    {{ if gt $count 1 }}
      <button class="absolute left-3 top-1/2 -translate-y-1/2 z-20 grid place-items-center h-10 w-10 rounded-full bg-white/80 dark:bg-gray-800/80 shadow hover:bg-white dark:hover:bg-gray-700"
              data-prev aria-label="Previous">
        <span class="sr-only">Prev</span>
        <svg viewBox="0 0 20 20" width="20" height="20" fill="currentColor"><path d="M12.7 15.3a1 1 0 0 1-1.4 0l-4-4a1 1 0 0 1 0-1.4l4-4a1 1 0 1 1 1.4 1.4L9.42 10l3.3 3.3a1 1 0 0 1 0 1.4Z"/></svg>
      </button>
      <button class="absolute right-3 top-1/2 -translate-y-1/2 z-20 grid place-items-center h-10 w-10 rounded-full bg-white/80 dark:bg-gray-800/80 shadow hover:bg-white dark:hover:bg-gray-700"
              data-next aria-label="Next">
        <span class="sr-only">Next</span>
        <svg viewBox="0 0 20 20" width="20" height="20" fill="currentColor"><path d="M7.3 15.3a1 1 0 0 0 1.4 0l4-4a1 1 0 0 0 0-1.4l-4-4A1 1 0 1 0 7.3 6.7L10.58 10l-3.3 3.3a1 1 0 0 0 0 1.4Z"/></svg>
      </button>
    {{ end }}

    {{/* 外部 JS（Hugo 资源管道打包）——需要配套 assets/js/blocks/slider-tw.js */}}
    {{ $js := resources.Get "js/blocks/slider-tw.js" | js.Build | fingerprint }}
    <script src="{{ $js.RelPermalink }}" defer></script>
  </div>
</section>
