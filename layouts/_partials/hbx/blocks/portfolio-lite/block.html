{{/* Hugo Blox — Portfolio Lite (Tailwind + 原生JS过滤) */}}
{{ $page := .wcPage }}
{{ $block := .wcBlock }}

{{/* 读取配置 */}}
{{ $pageType := $block.content.page_type | default "" }}
{{ $folders := $block.content.filters.folders | default (slice) }}
{{ $buttons := $block.content.buttons | default (slice (dict "name" "All" "filter" "*")) }}
{{ $columns := $block.design.columns | default 3 }}
{{ $view := $block.design.view | default "card" }}
{{ $tagKey := $block.content.tag_param | default "tags" }}

{{/* 收集内容 */}}
{{ $query := site.RegularPages }}
{{ if $pageType }}
{{ $query = union (where $query "Params.type" "==" $pageType) (where $query "Type" "==" $pageType) }}
{{ end }}
{{ if gt (len $folders) 0 }}
{{ $tmp := slice }}
{{ range $folders }}
{{ $tmp = union $tmp (where $query "Section" .) }}
{{ end }}
{{ if gt (len $tmp) 0 }}{{ $query = $tmp }}{{ end }}
{{ end }}

{{/* 排序（避免在一行里拼接字符串导致引号问题） */}}
{{ $sortBy := $block.content.sort_by | default "Date" }}
{{ $asc := $block.content.sort_ascending | default false }}
{{ if $asc }}
{{ $query = sort $query $sortBy }}
{{ else }}
{{ $query = sort $query $sortBy "desc" }}
{{ end }}

{{/* 生成网格列 class，避免在属性里嵌套 if */}}
{{ $gridClass := "md:grid-cols-1" }}
{{ if ge $columns 4 }}
{{ $gridClass = "md:grid-cols-2 xl:grid-cols-4" }}
{{ else if eq $columns 3 }}
{{ $gridClass = "md:grid-cols-2 xl:grid-cols-3" }}
{{ else if eq $columns 2 }}
{{ $gridClass = "md:grid-cols-2" }}
{{ end }}

<section class="{{ $block.design.css_class }}">
  <div class="text-center">
    {{ with $block.content.title }}<h2 class="mb-6 text-2xl font-bold">{{ . }}</h2>{{ end }}
    {{ with $block.content.text }}<p class="mb-6 text-gray-600 dark:text-gray-300 max-w-prose mx-auto">{{ . |
      markdownify }}</p>{{ end }}
  </div>


  {{ if gt (len $buttons) 1 }}
  <div class="mb-6 flex flex-wrap gap-2 justify-center" data-portfolio-toolbar>
    {{ range $buttons }}
    <button
      class="px-3 py-1.5 rounded-full text-sm border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 data-[active=true]:bg-gray-900 data-[active=true]:text-white data-[active=true]:border-gray-900"
      data-filter="{{ .filter | lower }}">{{ .name }}</button>
    {{ end }}
  </div>
  {{ end }}

  <div class="grid gap-6 {{ $gridClass }}" data-portfolio-grid>
    {{ range $p := $query }}
    {{/* 取标签数组并转小写列表：兼容 slice 或逗号分隔的字符串 */}}
    {{ $tags := slice }}
    {{ $raw := index $p.Params $tagKey }}

    {{ if $raw }}
    {{ if (reflect.IsSlice $raw) }}
    {{ range $raw }}
    {{ $tags = $tags | append (lower (printf "%v" .)) }}
    {{ end }}
    {{ else }}
    {{/* 处理字符串：按逗号切分，去空格，小写 */}}
    {{ range (split (lower (printf "%v" $raw)) ",") }}
    {{ $t := trim . " " }}
    {{ if $t }}{{ $tags = $tags | append $t }}{{ end }}
    {{ end }}
    {{ end }}
    {{ end }}

    {{ $tagsStr := delimit $tags "," }}

    <article
      class="rounded-2xl overflow-hidden bg-white dark:bg-gray-800 shadow hover:shadow-lg transition-all duration-300"
      data-portfolio-item data-tags="{{ $tagsStr }}">
      {{ with $p.Resources.GetMatch "*featured*" }}
      {{ $img := .Fill "800x450 center webp" }}
      <a href="{{ $p.RelPermalink }}" class="block aspect-[16/9] overflow-hidden">
        <img src="{{ $img.RelPermalink }}" width="{{ $img.Width }}" height="{{ $img.Height }}" alt="{{ $p.Title }}"
          class="w-full h-full object-cover transition-transform duration-300 hover:scale-105">
      </a>
      {{ end }}

      <div class="p-5">
        <h3 class="text-lg font-semibold">
          <a href="{{ $p.RelPermalink }}">{{ $p.Title }}</a>
        </h3>
        {{ with $p.Params.summary }}
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">{{ . }}</p>
        {{ end }}
        {{ if gt (len $tags) 0 }}
        <div class="mt-3 flex flex-wrap gap-1.5">
          {{ range $t := $tags }}
          <span
            class="px-2 py-0.5 text-xs rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">{{ $t
            }}</span>
          {{ end }}
        </div>
        {{ end }}
      </div>
    </article>
    {{ end }}
  </div>

  <script>
    (function () {
      const root = document.currentScript.closest('section');
      const toolbar = root.querySelector('[data-portfolio-toolbar]');
      const grid = root.querySelector('[data-portfolio-grid]');
      if (!grid) return;
      const items = Array.from(grid.querySelectorAll('[data-portfolio-item]'));

      function applyFilter(val) {
        const f = (val || '*').toLowerCase();
        items.forEach(el => {
          if (f === '*') { el.hidden = false; return; }
          const tags = (el.getAttribute('data-tags') || '').split(',').map(s => s.trim());
          el.hidden = !tags.includes(f);
        });
      }

      if (toolbar) {
        const btns = Array.from(toolbar.querySelectorAll('[data-filter]'));
        function setActive(btn) {
          btns.forEach(b => b.dataset.active = (b === btn ? 'true' : 'false'));
        }
        btns.forEach(btn => {
          btn.addEventListener('click', () => {
            setActive(btn);
            applyFilter(btn.dataset.filter);
          });
        });
        if (btns[0]) { setActive(btns[0]); applyFilter(btns[0].dataset.filter); }
      } else {
        applyFilter('*');
      }
    })();
  </script>
</section>