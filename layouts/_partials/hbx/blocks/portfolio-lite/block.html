{{/* Hugo Blox — Collection with category filter */}}

{{ $page  := .wcPage }}
{{ $block := .wcBlock }}

{{/* ------- 基础配置（与官方 collection 对齐） ------- */}}
{{ $view      := $block.design.view | default "card" }}
{{ $columns   := $block.design.columns | default 3 }}
{{ $pageType  := $block.content.page_type | default "" }}

{{ $folders   := $block.content.filters.folders | default (slice) }}

{{ $sortBy    := $block.content.sort_by | default "Date" }}
{{ $sortOrder := $block.content.sort_order | default "desc" }}
{{ $offset    := $block.content.offset | default 0 }}
{{ $count     := $block.content.count  | default 0 }}

{{ $archive_page := $block.content.archive_page | default "" }}

{{/* 分类过滤相关配置 */}}
{{ $buttons := $block.content.buttons | default (slice) }}
{{ $tagKey  := $block.content.tag_param | default "tags" }}

{{/* ------- 收集内容：基本沿用官方 collection 思路 ------- */}}
{{ $query := site.RegularPages }}

{{ if $pageType }}
  {{ $query = union
      (where $query "Params.type" "==" $pageType)
      (where $query "Type" "==" $pageType)
  }}
{{ end }}

{{ if gt (len $folders) 0 }}
  {{ $tmp := slice }}
  {{ range $p := $query }}
    {{ $match := false }}
    {{ range $f := $folders }}
      {{ if in $p.RelPermalink (printf "/%s/" $f) }}
        {{ $match = true }}
      {{ end }}
    {{ end }}
    {{ if $match }}
      {{ $tmp = $tmp | append $p }}
    {{ end }}
  {{ end }}
  {{ $query = $tmp }}
{{ end }}

{{/* 排序 */}}
{{ if eq (lower $sortOrder) "asc" }}
  {{ $query = sort $query $sortBy "asc" }}
{{ else }}
  {{ $query = sort $query $sortBy "desc" }}
{{ end }}

{{/* offset + count */}}
{{ if gt $offset 0 }}
  {{ if gt (len $query) $offset }}
    {{ $query = (after $offset $query) }}
  {{ else }}
    {{ $query = slice }}
  {{ end }}
{{ end }}

{{ if and (gt $count 0) (gt (len $query) $count) }}
  {{ $query = first $count $query }}
{{ end }}

{{/* 传给 views/* 的 config（和官方 collection 同风格） */}}
{{ $config := dict
    "columns" $columns
    "len" (len $query)
    "fill_image" ($block.design.fill_image | default true)
    "show_date" ($block.design.show_date | default true)
    "show_read_time" ($block.design.show_read_time | default true)
    "show_read_more" ($block.design.show_read_more | default true)
}}

<section class="py-8 md:py-12" data-collection-filter>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

    <div class="text-center mb-6">
      {{ with $block.content.title }}
        <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">
          {{ . | $page.RenderString }}
        </h2>
      {{ end }}

      {{ with $block.content.text }}
        <div class="text-gray-600 dark:text-gray-300">
          {{ . | $page.RenderString }}
        </div>
      {{ end }}
    </div>

    {{/* -------- 分类按钮 toolbar -------- */}}
{{ if gt (len $buttons) 0 }}
  <div class="flex justify-center mb-8">
    <div
      class="inline-flex rounded-full bg-primary-50/80 dark:bg-slate-900/60
             px-1 py-1 shadow-sm
             ring-1 ring-slate-200/80 dark:ring-slate-700/80"
      data-collection-toolbar
    >
      {{ range $i, $btn := $buttons }}
        {{ $name   := $btn.name   | default "All" }}
        {{ $filter := $btn.filter | default "*" }}
        <button
          type="button"
          class="px-6 py-1.5 text-sm font-medium rounded-full
                 text-slate-600 dark:text-slate-200
                 hover:text-primary-600 hover:bg-primary-300/70
                 dark:hover:text-primary-300 dark:hover:bg-slate-800/80
                 transition
                 data-[active=true]:bg-primary-600
                 data-[active=true]:text-white
                 data-[active=true]:shadow-sm"
          data-filter="{{ $filter }}"
          data-active="{{ if eq $i 0 }}true{{ else }}false{{ end }}"
        >
          {{ $name }}
        </button>
      {{ end }}
    </div>
  </div>
{{ end }}

    {{/* -------- 官方 collection 视图起始 -------- */}}
    {{ partial "functions/render_view" (dict
        "fragment" "start"
        "page" $block
        "view" $view
        "config" $config
    ) }}

    {{/* -------- 列表循环：每个 item 外包一层 data-tags 方便过滤 -------- */}}
    {{ range $index, $item := $query }}

      {{/* 计算当前条目的标签字符串，供前端过滤用 */}}
      {{ $tags := slice }}
      {{ $raw := index $item.Params $tagKey }}
      {{ if $raw }}
        {{ if (reflect.IsSlice $raw) }}
          {{ range $raw }}
            {{ $tags = $tags | append (lower (printf "%v" .)) }}
          {{ end }}
        {{ else }}
          {{ range (split (lower (printf "%v" $raw)) ",") }}
            {{ $t := trim . " " }}
            {{ if $t }}{{ $tags = $tags | append $t }}{{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{ $tagsStr := delimit $tags "," }}

      <div data-collection-item data-tags="{{ $tagsStr }}">
        {{ partial "functions/render_view" (dict
            "page"  $block
            "item"  $item
            "view"  $view
            "index" $index
            "config" $config
        ) }}
      </div>

    {{ end }}

    {{ partial "functions/render_view" (dict
        "fragment" "end"
        "page" $block
        "view" $view
        "config" $config
    ) }}

    {{/* archive link 可选（完全沿用官方写法思路） */}}
    {{ with $archive_page }}
      {{ with site.GetPage . }}
        <div class="mt-6 text-right">
          <a href="{{ .RelPermalink }}" class="text-sm font-medium text-primary-600 hover:underline">
            {{ i18n "more" }} →
          </a>
        </div>
      {{ end }}
    {{ end }}

  </div>

  {{/* -------- 前端 JS：按钮 + 标签过滤 -------- */}}
  <script>
    (function () {
      const section = document.currentScript.closest('[data-collection-filter]');
      if (!section) return;

      const items   = Array.from(section.querySelectorAll('[data-collection-item]'));
      const toolbar = section.querySelector('[data-collection-toolbar]');
      const btns    = toolbar ? Array.from(toolbar.querySelectorAll('button[data-filter]')) : [];

      function applyFilter(filter) {
        const f = (filter || '*').trim().toLowerCase();
        items.forEach(el => {
          const tagsStr = (el.getAttribute('data-tags') || '').toLowerCase();
          const tags = tagsStr
            ? tagsStr.split(',').map(s => s.trim()).filter(Boolean)
            : [];
          if (!f || f === '*') {
            el.hidden = false;
          } else {
            el.hidden = !tags.includes(f);
          }
        });
      }

      if (btns.length) {
        function setActive(btn) {
          btns.forEach(b => b.dataset.active = (b === btn ? 'true' : 'false'));
        }
        btns.forEach(btn => {
          btn.addEventListener('click', () => {
            setActive(btn);
            applyFilter(btn.dataset.filter);
          });
        });
        const initial = btns.find(b => b.dataset.active === 'true') || btns[0];
        if (initial) {
          setActive(initial);
          applyFilter(initial.dataset.filter);
        } else {
          applyFilter('*');
        }
      } else {
        applyFilter('*');
      }
    })();
  </script>
</section>