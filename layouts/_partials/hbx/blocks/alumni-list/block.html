{{/* Hugo Blox: Alumni List Block (Manual Grouping Fix) */}}

{{ $page := .wcPage }}
{{ $block := .wcBlock }}

{{ $title := $block.content.title | emojify | $page.RenderString }}
{{ $subtitle := $block.content.subtitle | emojify | $page.RenderString }}
{{ $target_groups := $block.content.user_groups }}
{{ $query := slice }}

{{/* 1. 筛选逻辑 (保持之前的暴力匹配，因为它已经证明有效) */}}
{{ range where site.Pages "Section" "authors" }}
  {{ $author := . }}
  {{ $is_match := false }}
  {{ if $author.Params.user_groups }}
    {{ range $g := $author.Params.user_groups }}
      {{ range $t := $target_groups }}
        {{/* 忽略大小写和空格进行比较 */}}
        {{ if eq (lower (trim (printf "%s" $g) " ")) (lower (trim (printf "%s" $t) " ")) }}
          {{ $is_match = true }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ if $is_match }}
    {{ $query = $query | append $author }}
  {{ end }}
{{ end }}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">

  {{/* Header */}}
  <div class="flex flex-col items-center text-center mb-12">
    {{ with $title }}
      <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white tracking-tight uppercase">
        {{ . }}
      </h2>
      <div class="h-1 w-16 bg-primary-700 mx-auto mt-4 rounded-full"></div>
    {{ end }}
    {{ with $subtitle }}
      <p class="mt-4 text-xl text-gray-600 dark:text-gray-400">{{ . }}</p>
    {{ end }}
  </div>

  {{/* List Container */}}
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 overflow-hidden">
    
    {{/* Table Header */}}
    <div class="hidden md:flex items-center bg-gray-100 dark:bg-gray-900 border-b-2 border-primary-600 py-4 px-8 text-sm font-bold text-gray-800 dark:text-white uppercase tracking-wider">
      <div class="w-1/6 pl-2">Year</div>
      <div class="w-2/6">Name</div>
      <div class="w-1/6 text-center">Degree</div>
      <div class="w-2/6 text-right pr-2">Destination</div>
    </div>

    <div class="divide-y divide-gray-100 dark:divide-gray-700">
      
      {{ if eq (len $query) 0 }}
         <div class="p-8 text-center text-gray-500">
           No alumni found. (Debug: Groups matched successfully, but query is empty?)
         </div>
      {{ else }}

        {{/* ========================================================== */}}
        {{/* 2. 手动分组逻辑 (Manual Grouping) - 替代 GroupByParam        */}}
        {{/* ========================================================== */}}
        
        {{/* 第一步：收集所有的年份 */}}
        {{ $years := slice }}
        {{ range $query }}
          {{/* 强制转为字符串以统一类型，避免 Int vs String 问题 */}}
          {{ $y := printf "%s" (.Params.graduation_year | default "Unknown") }}
          {{ $years = $years | append $y }}
        {{ end }}
        {{ $years = $years | uniq | sort }}
        
        {{/* 倒序遍历年份 (最新的年份在最上面) */}}
        {{ range $y :=  $years }}
           {{/* 注意：这里需要反向遍历，因为 hugo 的 sort 默认是升序。
              或者我们可以在下面用 where 过滤出这个年份的人。
           */}}
        {{ end }}

        {{/* 更加简便的方法：直接对 Query 进行排序 (年份倒序)，然后渲染 */}}
        {{/* 这样虽然失去了严格的 "Group" 对象，但视觉上列表是一样的 */}}
        
        {{/* 先按 Degree 权重排序 (可选优化)，再按 Year 倒序 */}}
        {{ $sorted_query := sort $query "Params.graduation_year" "desc" }}
        
        {{ range $person := $sorted_query }}
            
            {{ $link := $person.RelPermalink }}
            {{ $year := $person.Params.graduation_year | default "N/A" }}
            {{ $degree := $person.Params.degree | default "PhD" }}
            {{ $destination := $person.Params.destination | default "Unknown" }}

            <div class="group flex flex-col md:flex-row md:items-center py-5 px-8 hover:bg-blue-50/50 dark:hover:bg-gray-700/50 transition-colors duration-200">
              
              {{/* Year */}}
              <div class="w-full md:w-1/6 mb-2 md:mb-0">
                 <span class="inline-block px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-bold rounded text-sm font-mono shadow-sm">
                   {{ $year }}
                 </span>
              </div>

              {{/* Name */}}
              <div class="w-full md:w-2/6 flex items-center gap-4 mb-2 md:mb-0">
                 {{ $avatar := ($person.Resources.ByType "image").GetMatch "*avatar*" }}
                 {{ if $avatar }}
                   {{ $avatar_img := $avatar.Fill "100x100 Center webp" }} 
                   <img src="{{ $avatar_img.RelPermalink }}" class="w-12 h-12 rounded-full object-cover border-2 border-white dark:border-gray-600 shadow-sm" loading="lazy">
                 {{ else }}
                   <div class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400 border-2 border-white dark:border-gray-600 shadow-sm">
                     <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                   </div>
                 {{ end }}

                 <a href="{{ $link }}" class="text-lg font-bold text-gray-900 dark:text-white hover:text-primary-600 transition-colors">
                   {{ $person.Title }}
                 </a>
              </div>

              {{/* Degree */}}
              <div class="w-full md:w-1/6 md:text-center mb-1 md:mb-0 pl-16 md:pl-0">
                <span class="text-sm font-semibold text-gray-600 dark:text-gray-300">
                  {{ $degree }}
                </span>
              </div>

              {{/* Destination */}}
              <div class="w-full md:w-2/6 md:text-right pl-16 md:pl-0 pr-2">
                 <div class="flex items-center md:justify-end gap-2 text-primary-700 dark:text-primary-400 font-bold">
                   <svg class="w-4 h-4 hidden md:block opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                   </svg>
                   <span>{{ $destination }}</span>
                 </div>
              </div>

            </div>
        {{ end }} {{/* End of range sorted_query */}}
      
      {{ end }} {{/* End of if len query > 0 */}}

    </div>
  </div>
</div>