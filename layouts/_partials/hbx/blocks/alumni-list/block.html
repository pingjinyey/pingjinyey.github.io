{{/* Hugo Blox: Alumni List Block (Deep Debug Mode) */}}

{{ $page := .wcPage }}
{{ $block := .wcBlock }}
{{ $title := $block.content.title | emojify | $page.RenderString }}
{{ $subtitle := $block.content.subtitle | emojify | $page.RenderString }}

{{ $target_groups := $block.content.user_groups }}
{{ $query := slice }}

{{/* ================= DEBUG START (ËØ∑Â∞ÜÈÉ®ÁΩ≤ÂêéÊòæÁ§∫ÁöÑËøôÈÉ®ÂàÜÂÜÖÂÆπÂèëÁªôÊàë) ================= */}}
<div style="background: #fff0f0; border: 2px solid red; color: #333; padding: 15px; margin: 20px 0; font-family: monospace; font-size: 12px; overflow-x: auto;">
  <h3 style="color: red; font-weight: bold; font-size: 14px;">üõ†Ô∏è DEEP DEBUG INFO</h3>
  
  <p><strong>1. Block Configuration:</strong></p>
  <ul>
    <li>Target Groups (Raw): {{ $target_groups }}</li>
    <li>Target Groups (Type): {{ printf "%T" $target_groups }}</li>
    <li>Section "authors" Count: {{ len (where site.Pages "Section" "authors") }}</li>
  </ul>

  <p><strong>2. Author Scanning (First 10):</strong></p>
  <table style="width: 100%; border-collapse: collapse; border: 1px solid #ccc;">
    <tr style="background: #eee;">
      <th style="border: 1px solid #ccc; padding: 4px;">Name</th>
      <th style="border: 1px solid #ccc; padding: 4px;">User Groups (Raw)</th>
      <th style="border: 1px solid #ccc; padding: 4px;">Type</th>
      <th style="border: 1px solid #ccc; padding: 4px;">Comparison Log</th>
      <th style="border: 1px solid #ccc; padding: 4px;">Result</th>
    </tr>
    {{ range first 10 (where site.Pages "Section" "authors") }}
      {{ $author_name := .Title }}
      {{ $author_groups := .Params.user_groups }}
      {{ $is_match := false }}
      {{ $log := "" }}

      {{ if $author_groups }}
        {{/* Â∞ùËØïÂåπÈÖçÈÄªËæë */}}
        {{ range $g := $author_groups }}
          {{ range $t := $target_groups }}
            {{/* Âº∫ÂäõÊ∏ÖÊ¥óÔºöËΩ¨Â≠óÁ¨¶‰∏≤ -> ÂéªÁ©∫Ê†º -> ËΩ¨Â∞èÂÜô */}}
            {{ $g_clean := lower (trim (printf "%s" $g) " ") }}
            {{ $t_clean := lower (trim (printf "%s" $t) " ") }}
            
            {{ if eq $g_clean $t_clean }}
              {{ $is_match = true }}
              {{ $log = printf "%s [MATCH: '%s'=='%s']" $log $g_clean $t_clean }}
            {{ else }}
              {{ $log = printf "%s [Diff: '%s'!='%s']" $log $g_clean $t_clean }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ else }}
        {{ $log = "No user_groups found" }}
      {{ end }}

      {{ if $is_match }}{{ $query = $query | append . }}{{ end }}

      <tr>
        <td style="border: 1px solid #ccc; padding: 4px;">{{ $author_name }}</td>
        <td style="border: 1px solid #ccc; padding: 4px;">{{ $author_groups }}</td>
        <td style="border: 1px solid #ccc; padding: 4px;">{{ printf "%T" $author_groups }}</td>
        <td style="border: 1px solid #ccc; padding: 4px; color: #666;">{{ $log }}</td>
        <td style="border: 1px solid #ccc; padding: 4px; font-weight: bold; color: {{ if $is_match }}green{{else}}red{{end}};">
          {{ if $is_match }}MATCH{{ else }}FAIL{{ end }}
        </td>
      </tr>
    {{ end }}
  </table>
  <p><strong>3. Final Query Result Count:</strong> {{ len $query }}</p>
</div>
{{/* ================= DEBUG END ================= */}}


<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
  {{/* Header */}}
  <div class="flex flex-col items-center text-center mb-12">
    {{ with $title }}
      <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white tracking-tight uppercase">{{ . }}</h2>
      <div class="h-1 w-16 bg-primary-700 mx-auto mt-4 rounded-full"></div>
    {{ end }}
    {{ with $subtitle }}<p class="mt-4 text-xl text-gray-600 dark:text-gray-400">{{ . }}</p>{{ end }}
  </div>

  {{/* List Container */}}
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 overflow-hidden">
    <div class="hidden md:flex items-center bg-gray-100 dark:bg-gray-900 border-b-2 border-primary-600 py-4 px-8 text-sm font-bold text-gray-800 dark:text-white uppercase tracking-wider">
      <div class="w-1/6 pl-2">Year</div>
      <div class="w-2/6">Name</div>
      <div class="w-1/6 text-center">Degree</div>
      <div class="w-2/6 text-right pr-2">Destination</div>
    </div>

    <div class="divide-y divide-gray-100 dark:divide-gray-700">
      {{ if eq (len $query) 0 }}
         <div class="p-8 text-center text-gray-500">No alumni found (See Debug Info above).</div>
      {{ else }}
        {{ $yearGroups := $query.GroupByParam "graduation_year" }}
        {{ range $group := sort $yearGroups "Key" "desc" }}
          {{ $postdocs := where $group.Pages "Params.degree" "in" (slice "Postdoc" "Post-doc" "Post Doctor") }}
          {{ $phds := where $group.Pages "Params.degree" "in" (slice "PhD" "Ph.D." "Doctor" "Doctorate") }}
          {{ $masters := where $group.Pages "Params.degree" "in" (slice "Master" "Masters" "M.Sc." "M.Eng.") }}
          {{ $bachelors := where $group.Pages "Params.degree" "in" (slice "Bachelor" "Bachelors" "B.Sc." "B.Eng." "Undergraduate") }}
          {{ $sorted := $postdocs | append $phds | append $masters | append $bachelors }}
          {{ $others := $group.Pages | complement $sorted }}
          {{ $finalList := $sorted | append $others }}

          {{ range $person := $finalList }}
            {{ $link := $person.RelPermalink }}
            {{ $year := $person.Params.graduation_year | default "N/A" }}
            {{ $degree := $person.Params.degree | default "PhD" }}
            {{ $destination := $person.Params.destination | default "Unknown" }}

            <div class="group flex flex-col md:flex-row md:items-center py-5 px-8 hover:bg-blue-50/50 dark:hover:bg-gray-700/50 transition-colors duration-200">
              <div class="w-full md:w-1/6 mb-2 md:mb-0"><span class="inline-block px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-bold rounded text-sm font-mono shadow-sm">{{ $year }}</span></div>
              <div class="w-full md:w-2/6 flex items-center gap-4 mb-2 md:mb-0">
                 {{ $avatar := ($person.Resources.ByType "image").GetMatch "*avatar*" }}
                 {{ if $avatar }}
                   {{ $avatar_img := $avatar.Fill "100x100 Center webp" }} <img src="{{ $avatar_img.RelPermalink }}" class="w-12 h-12 rounded-full object-cover border-2 border-white dark:border-gray-600 shadow-sm" loading="lazy">
                 {{ else }}
                   <div class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400 border-2 border-white dark:border-gray-600 shadow-sm"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></div>
                 {{ end }}
                 <a href="{{ $link }}" class="text-lg font-bold text-gray-900 dark:text-white hover:text-primary-600 transition-colors">{{ $person.Title }}</a>
              </div>
              <div class="w-full md:w-1/6 md:text-center mb-1 md:mb-0 pl-16 md:pl-0"><span class="text-sm font-semibold text-gray-600 dark:text-gray-300">{{ $degree }}</span></div>
              <div class="w-full md:w-2/6 md:text-right pl-16 md:pl-0 pr-2">
                 <div class="flex items-center md:justify-end gap-2 text-primary-700 dark:text-primary-400 font-bold">
                   <svg class="w-4 h-4 hidden md:block opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                   <span>{{ $destination }}</span>
                 </div>
              </div>
            </div>
          {{ end }}
        {{ end }}
      {{ end }}
    </div>
  </div>
</div>