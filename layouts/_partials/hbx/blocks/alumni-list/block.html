{{/* Hugo Blox: Alumni List Block with Advanced Sorting */}}

{{ $page := .wcPage }}
{{ $block := .wcBlock }}

{{ $title := $block.content.title | emojify | $page.RenderString }}
{{ $subtitle := $block.content.subtitle | emojify | $page.RenderString }}
{{ $target_groups := $block.content.user_groups }}
{{ $query := slice }}

{{/* 1. 筛选逻辑 (保持不变) */}}
{{ range where site.Pages "Section" "authors" }}
  {{ $author := . }}
  {{ $is_match := false }}
  {{ if $author.Params.user_groups }}
    {{ range $g := $author.Params.user_groups }}
      {{ range $t := $target_groups }}
        {{ if eq (lower (trim (printf "%s" $g) " ")) (lower (trim (printf "%s" $t) " ")) }}
          {{ $is_match = true }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ if $is_match }}
    {{ $query = $query | append $author }}
  {{ end }}
{{ end }}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">

  {{/* Header */}}
  <div class="flex flex-col items-center text-center mb-12">
    {{ with $title }}
      <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white tracking-tight uppercase">
        {{ . }}
      </h2>
      <div class="h-1 w-16 bg-primary-700 mx-auto mt-4 rounded-full"></div>
    {{ end }}
    {{ with $subtitle }}
      <p class="mt-4 text-xl text-gray-600 dark:text-gray-400">{{ . }}</p>
    {{ end }}
  </div>

  {{/* List Container */}}
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 overflow-hidden">
    
    {{/* Table Header */}}
    <div class="hidden md:flex items-center bg-gray-100 dark:bg-gray-900 border-b-2 border-primary-600 py-4 px-8 text-sm font-bold text-gray-800 dark:text-white uppercase tracking-wider">
      <div class="w-1/6 pl-2">Year</div>
      <div class="w-2/6">Name</div>
      <div class="w-1/6 text-center">Degree</div>
      <div class="w-2/6 text-right pr-2">Destination</div>
    </div>

    <div class="divide-y divide-gray-100 dark:divide-gray-700">
      
      {{ if eq (len $query) 0 }}
         <div class="p-8 text-center text-gray-500">
           No alumni found.
         </div>
      {{ else }}

        {{/* ========================================================== */}}
        {{/* 2. 高级排序逻辑 (Weighted Sorting)                          */}}
        {{/* ========================================================== */}}
        
        {{/* 构建一个包含权重的临时列表 */}}
        {{ $weighted_list := slice }}

        {{ range $person := $query }}
            {{/* 获取学位并转小写用于比较 */}}
            {{ $d := lower ($person.Params.degree | default "") }}
            {{ $weight := 99 }} {{/* 默认为其它 */}}

            {{/* 权重定义 (数字越小排越前):
               10: 博士后 (Postdoc)
               20: 博士 (PhD)
               30: 硕士 (Master)
               40: 本科 (Bachelor)
               99: 其他
            */}}

            {{/* 兼容性匹配：包含特定关键词即命中 */}}
            {{ if or (in $d "postdoc") (in $d "post-doc") (in $d "博士后") }}
                {{ $weight = 10 }}
            {{ else if or (in $d "phd") (in $d "ph.d") (in $d "doctor") (in $d "博士") }}
                {{ $weight = 20 }}
            {{ else if or (in $d "master") (in $d "m.sc") (in $d "ma") (in $d "ms") (in $d "meng") (in $d "硕士") }}
                {{ $weight = 30 }}
            {{ else if or (in $d "bachelor") (in $d "b.sc") (in $d "ba") (in $d "bs") (in $d "beng") (in $d "本科") (in $d "学士") }}
                {{ $weight = 40 }}
            {{ end }}

            {{/* 将 Page 对象和计算出的排序键打包 */}}
            {{/* 注意：Year 这里我们确保是 String 或 Int 统一，用于排序 */}}
            {{ $item := dict "Page" $person "Weight" $weight "Name" $person.Title "Year" ($person.Params.graduation_year | default "0") }}
            {{ $weighted_list = $weighted_list | append $item }}
        {{ end }}

        {{/* 执行链式排序 (利用 Stable Sort 特性)：
           1. 先排最不重要的 -> Name (A-Z)
           2. 再排次重要的 -> Degree Weight (Asc)
           3. 最后排最重要的 -> Year (Desc)
        */}}
        {{ $sorted := sort $weighted_list "Name" "asc" }}
        {{ $sorted = sort $sorted "Weight" "asc" }}
        {{ $sorted = sort $sorted "Year" "desc" }}

        {{/* 3. 渲染循环 */}}
        {{ range $item := $sorted }}
            {{ $person := $item.Page }}
            
            {{ $link := $person.RelPermalink }}
            {{ $year := $person.Params.graduation_year | default "N/A" }}
            {{ $degree := $person.Params.degree | default "" }}
            {{ $destination := $person.Params.destination | default "Unknown" }}

            <div class="group flex flex-col md:flex-row md:items-center py-5 px-8 hover:bg-blue-50/50 dark:hover:bg-gray-700/50 transition-colors duration-200">
              
              {{/* Year */}}
              <div class="w-full md:w-1/6 mb-2 md:mb-0">
                 <span class="inline-block px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-bold rounded text-sm font-mono shadow-sm">
                   {{ $year }}
                 </span>
              </div>

              {{/* Name & Avatar */}}
              <div class="w-full md:w-2/6 flex items-center gap-4 mb-2 md:mb-0">
                 {{ $avatar := ($person.Resources.ByType "image").GetMatch "*avatar*" }}
                 
                 {{/* 头像逻辑：有图显示图，无图显示默认SVG */}}
                 {{ if $avatar }}
                   {{ $avatar_img := $avatar.Fill "100x100 Center webp" }} 
                   <img src="{{ $avatar_img.RelPermalink }}" class="w-12 h-12 rounded-full object-cover border-2 border-white dark:border-gray-600 shadow-sm" loading="lazy">
                 {{ else }}
                   {{/* 默认头像占位符 */}}
                   <div class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-400 border-2 border-white dark:border-gray-600 shadow-sm overflow-hidden">
                      <svg class="w-8 h-8 relative top-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" />
                      </svg>
                   </div>
                 {{ end }}

                 <a href="{{ $link }}" class="text-lg font-bold text-gray-900 dark:text-white hover:text-primary-600 transition-colors">
                   {{ $person.Title }}
                 </a>
              </div>

              {{/* Degree */}}
              <div class="w-full md:w-1/6 md:text-center mb-1 md:mb-0 pl-16 md:pl-0">
                {{ if $degree }}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-primary-50 text-primary-800 dark:bg-primary-900 dark:text-primary-200">
                  {{ $degree }}
                </span>
                {{ end }}
              </div>

              {{/* Destination */}}
              <div class="w-full md:w-2/6 md:text-right pl-16 md:pl-0 pr-2">
                 <div class="flex items-center md:justify-end gap-2 text-gray-700 dark:text-gray-300 font-medium">
                   <svg class="w-4 h-4 hidden md:block opacity-70 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                   </svg>
                   <span>{{ $destination }}</span>
                 </div>
              </div>

            </div>
        {{ end }} {{/* End of range sorted */}}
      
      {{ end }} {{/* End of if len query > 0 */}}

    </div>
  </div>
</div>